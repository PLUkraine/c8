#include <assert.h>
#include <stdlib.h>
#include "c8.h"

#define T C8_T

static const uint16_t C8_START_ADDR = 0x200;
static const uint16_t C8_LAST_ADDR  = 0xFFF;

static const uint8_t C8_DIGITS[] = {
    0xF0, 0x90, 0x90, 0x90, 0xF0,
    0x20, 0x60, 0x20, 0x20, 0x70,
    0xF0, 0x10, 0xF0, 0x80, 0xF0,
    0xF0, 0x10, 0xF0, 0x10, 0xF0,
    0x90, 0x90, 0xF0, 0x10, 0x10,
    0xF0, 0x80, 0xF0, 0x10, 0xF0,
    0xF0, 0x80, 0xF0, 0x90, 0xF0,
    0xF0, 0x10, 0x20, 0x40, 0x40,
    0xF0, 0x90, 0xF0, 0x90, 0xF0,
    0xF0, 0x90, 0xF0, 0x10, 0xF0,
    0xF0, 0x90, 0xF0, 0x90, 0x90,
    0xE0, 0x90, 0xE0, 0x90, 0xE0,
    0xF0, 0x80, 0x80, 0x80, 0xF0,
    0xE0, 0x90, 0x90, 0x90, 0xE0,
    0xF0, 0x80, 0xF0, 0x80, 0xF0,
    0xF0, 0x80, 0xF0, 0x80, 0x80,
};


// 3.5795 MHz?
struct T {
    uint8_t     Vx[16];
    uint16_t    I;
    uint8_t     DT;
    uint8_t     ST;
    uint16_t    PC;
    uint8_t     SP;
    uint16_t    Stack[16];
    uint8_t    *Ram;
};

T C8_init(void)
{
    void *malloc_call = NULL;
    T c8 = NULL;

    malloc_call = malloc(sizeof(*c8));
    assert(malloc_call);
    c8 = (T) malloc_call;
    
    malloc_call = malloc(C8_LAST_ADDR);
    assert(malloc_call);
    c8->Ram = (uint8_t *)malloc_call;

    return c8;
}


void C8_free(T *c8)
{
    assert(c8 && *c8);
    free((*c8)->Ram);
    free(*c8);
    *c8 = NULL;
}

#undef T